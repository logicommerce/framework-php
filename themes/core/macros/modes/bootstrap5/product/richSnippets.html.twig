{%- macro richSnippets(args) -%}
    {%- set richSnippets = args.richSnippets -%}
    {%- set images = richSnippets.images|filter(image => image|length) -%}
    <script type="application/ld+json">
        {
            "@context": "{{- richSnippets.context -}}",
            "@type": "{{- richSnippets.type -}}",
            {% if richSnippets.productGroupId|length -%}
                "productGroupId": {{- outputJsonHtmlString(richSnippets.productGroupId|striptags) -}},
            {% endif -%}
            {% if richSnippets.name|length -%}
                "name": {{- outputJsonHtmlString(richSnippets.name|striptags) -}},
            {% endif -%}
            {% if images|length -%}
                "image": [
                    {%- for image in images -%}
                        "{{- image -}}"{%- if not loop.last -%},{%- endif -%}
                    {%- endfor -%}
                ],
            {% endif -%}
            {% if richSnippets.description|striptags|length -%}
                "description": {{ outputJsonHtmlString(richSnippets.description|striptags) }},
            {% endif -%}
            {% if richSnippets.sku|length -%}
                "sku": "{{- richSnippets.sku -}}",
            {% endif -%}
            {% if richSnippets.mpn|length -%}
                "mpn": "{{- richSnippets.mpn -}}",
            {% endif -%}
            {% if richSnippets.gtin8|length -%}
                "gtin8": "{{- richSnippets.gtin8 -}}",
            {% endif -%}
            {% if richSnippets.gtin13|length -%}
                "gtin13": "{{- richSnippets.gtin13 -}}",
            {% endif -%}
            {% if richSnippets.gtin14|length -%}
                "gtin14": "{{- richSnippets.gtin14 -}}",
            {% endif -%}
            {% if richSnippets.isbn|length -%}
                "isbn": "{{- richSnippets.isbn -}}",
            {% endif -%}
            {% if richSnippets.brand|length -%}
                "brand": {
                    "@type": "Brand",
                    "name": {{- outputJsonHtmlString(richSnippets.brand) -}}
                },
            {% endif -%}
            {% if richSnippets.additionalProperties|length -%}
                "additionalProperty": [
                    {%- for property in richSnippets.additionalProperties -%}
                        {
                            "@type": "{{- property.type -}}",
                            "name": {{- outputJsonHtmlString(property.name) -}},
                            "value": {{- outputJsonHtmlString(property.value) -}}
                        }{%- if not loop.last -%},{%- endif -%}
                    {%- endfor -%}
                ],
            {% endif -%}
            {% if richSnippets.variants|length -%}
                {% if richSnippets.variesBy|length -%}
                    "variesBy" : [    
                        {%- for variesBy in richSnippets.variesBy -%}
                            "{{- variesBy -}}"{%- if not loop.last -%},{%- endif -%}
                        {%- endfor -%}
                    ],         
                {% endif -%}                
                "hasVariant" : [
                    {%- for variant in richSnippets.variants -%}
                        {
                            "@type": "{{- variant.type -}}",
                            {% if variant.variantOf|length -%}
                                "isVariantOf": {
                                    "@type": "{{- richSnippets.type -}}",
                                    "name": {{- outputJsonHtmlString(variant.variantOf) -}}
                                },
                            {% endif -%}                            
                            {% if variant.size|length -%}
                                "size": {{- outputJsonHtmlString(variant.size) -}},
                            {% endif -%}
                            {% if variant.color|length -%}
                                "color": {{- outputJsonHtmlString(variant.color) -}},
                            {% endif -%}
                            {% if variant.material|length -%}
                                "material": {{- outputJsonHtmlString(variant.material) -}},
                            {% endif -%}
                            {% if variant.name|length -%}
                                "name": {{- outputJsonHtmlString(variant.name) -}},
                            {% endif -%}
                            {% if variant.images|length -%}
                                {%- set vimages = richSnippets.images|filter(image => image|length) -%}
                                "image": [
                                    {%- for image in vimages -%}
                                        "{{- image -}}"{%- if not loop.last -%},{%- endif -%}
                                    {%- endfor -%}
                                ],
                            {% endif -%}
                            {% if variant.sku|length -%}
                                "sku": "{{- variant.sku -}}",
                            {% endif -%}                            
                            {% if variant.gtin8|length -%}
                                "gtin8": "{{- variant.gtin8 -}}",
                            {% endif -%}
                            {% if variant.gtin13|length -%}
                                "gtin13": "{{- variant.gtin13 -}}",
                            {% endif -%}
                            {% if variant.gtin14|length -%}
                                "gtin14": "{{- variant.gtin14 -}}",
                            {% endif -%}
                            {% if variant.isbn|length -%}
                                "isbn": "{{- variant.isbn -}}",
                            {% endif -%}
                            {% if variant.additionalProperties|length -%}
                                "additionalProperty": [
                                    {%- for property in variant.additionalProperties -%}
                                        {
                                            "@type": "{{- property.type -}}",
                                            "name": {{- outputJsonHtmlString(property.name) -}},
                                            "value": {{- outputJsonHtmlString(property.value) -}}
                                        }{%- if not loop.last -%},{%- endif -%}
                                    {%- endfor -%}
                                ],
                            {% endif -%}                            
                            "offers": {
                                "@type": "{{- variant.offers.type -}}",                                    
                                "url": "{{- variant.offers.url -}}",
                                "priceCurrency": "{{- variant.offers.priceCurrency -}}",
                                "price": "{{- variant.offers.price|number_format(2, '.', '') -}}",
                                "priceValidUntil": "{{- variant.offers.priceValidUntil.dateTime|date('Y-m-d') -}}",
                                "availability": "https://schema.org/{{- variant.offers.availability -}}"
                            }                            
                        }{%- if not loop.last -%},{%- endif -%}
                    {%- endfor -%}
                ],
            {% endif -%}
            {% if richSnippets.review|length -%}
                "review" : [
                    {#- {%- set review = richSnippets.review[0] -%} -#}
                    {%- for review in richSnippets.review -%}
                        {
                            "@type": "{{- review.type -}}",                            
                            "name": {{- outputJsonHtmlString(review.name) -}},
                            "description": {{ outputJsonHtmlString(review.description|striptags) }},
                            "datePublished": "{{- review.datePublished.dateTime|date('Y-m-d') -}}",
                            "reviewRating": {
                                "@type": "{{- review.reviewRating.type -}}",
                                "@context": "{{- review.reviewRating.context -}}",
                                "ratingValue": "{{- review.reviewRating.ratingValue -}}",
                                "bestRating": "{{- review.reviewRating.bestRating -}}",
                                "worstRating": "{{- review.reviewRating.worstRating -}}"
                            },
                            "author": {
                                "@type": "{{- review.author.type -}}",                                
                                "name": {{- outputJsonHtmlString(review.author.name) -}}
                            }
                        }{%- if not loop.last -%},{%- endif -%}
                    {%- endfor -%}
                ],
            {% endif -%}
            {% if richSnippets.aggregateRating.ratingValue|length and (richSnippets.aggregateRating.ratingCount > 0 or richSnippets.aggregateRating.reviewCount > 0) -%}
                "aggregateRating": {
                    "@type": "{{- richSnippets.aggregateRating.type -}}",                    
                    {% if richSnippets.aggregateRating.ratingCount > 0 %}
                        "ratingCount": "{{- richSnippets.aggregateRating.ratingCount -}}",
                    {% endif %}
                    {% if richSnippets.aggregateRating.reviewCount > 0 %}
                        "reviewCount": "{{- richSnippets.aggregateRating.reviewCount -}}",
                    {% endif %}
                    "ratingValue": "{{- richSnippets.aggregateRating.ratingValue -}}",
                    "bestRating": "{{- richSnippets.aggregateRating.bestRating -}}",
                    "worstRating": "{{- richSnippets.aggregateRating.worstRating -}}"
                },
            {% endif -%}
            "offers": {
                "@type": "{{- richSnippets.offers.type -}}",                
                "url": "{{- richSnippets.offers.url -}}",
                "priceCurrency": "{{- richSnippets.offers.priceCurrency -}}",
                "price": "{{- richSnippets.offers.price|number_format(2, '.', '') -}}",
                "priceValidUntil": "{{- richSnippets.offers.priceValidUntil.dateTime|date('Y-m-d') -}}",
                "availability": "https://schema.org/{{- richSnippets.offers.availability -}}"
            }
        }
    </script>
{%- endmacro -%}